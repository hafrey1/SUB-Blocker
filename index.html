<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢é˜…èŠ‚ç‚¹åç§°è¿‡æ»¤å™¨ - GitHub Pages</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px; margin: 0 auto; padding: 20px; line-height: 1.6; 
        }
        .container { background: #f8f9fa; padding: 30px; border-radius: 12px; margin: 20px 0; }
        .input-group { margin: 15px 0; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 5px; }
        .input-group input, .input-group select { 
            width: 100%; padding: 12px; border: 2px solid #e9ecef; 
            border-radius: 8px; font-size: 16px; 
        }
        .btn { 
            background: #007bff; color: white; border: none; 
            padding: 12px 24px; border-radius: 8px; cursor: pointer; 
            font-size: 16px; margin: 10px 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .result { 
            background: #f8f9fa; border: 2px solid #dee2e6; 
            padding: 20px; border-radius: 8px; margin: 20px 0;
            font-family: 'Courier New', monospace; 
        }
        .status { padding: 10px; border-radius: 6px; margin: 10px 0; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .preview { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ“¡ è®¢é˜…èŠ‚ç‚¹åç§°è¿‡æ»¤å™¨</h1>
    <p>åŸºäºå®¢æˆ·ç«¯çš„è®¢é˜…èŠ‚ç‚¹åç§°å¤„ç†å·¥å…·ï¼Œåœ¨æµè§ˆå™¨ä¸­ç›´æ¥å¤„ç†æ‚¨çš„è®¢é˜…é“¾æ¥ã€‚</p>

    <div class="container">
        <div class="input-group">
            <label for="subscriptionUrl">è®¢é˜…é“¾æ¥</label>
            <input type="url" id="subscriptionUrl" placeholder="è¯·è¾“å…¥æ‚¨çš„è®¢é˜…é“¾æ¥..." />
        </div>

        <div class="input-group">
            <label for="language">è¾“å‡ºè¯­è¨€</label>
            <select id="language">
                <option value="EN">English (è‹±æ–‡)</option>
                <option value="CN">ä¸­æ–‡</option>
            </select>
        </div>

        <div class="input-group">
            <label for="prefix">è‡ªå®šä¹‰å‰ç¼€</label>
            <input type="text" id="prefix" value="â¥" placeholder="èŠ‚ç‚¹åç§°å‰ç¼€..." />
        </div>

        <div class="input-group">
            <label for="suffix">è‡ªå®šä¹‰åç¼€</label>
            <input type="text" id="suffix" value="áµáµ—" placeholder="èŠ‚ç‚¹åç§°åç¼€..." />
        </div>

        <button class="btn" onclick="processSubscription()">ğŸš€ å¤„ç†è®¢é˜…</button>
        <button class="btn btn-success" onclick="downloadResult()">ğŸ’¾ ä¸‹è½½ç»“æœ</button>
    </div>

    <div id="status"></div>
    <div id="preview"></div>
    <div id="result" style="display: none;"></div>

    <script>
        // å…¨å±€å˜é‡
        let processedContent = '';
        let originalFormat = '';

        // å›½å®¶åœ°åŒºæ˜ å°„ (ä» _worker.js ç§»æ¤)
        function getKeywordsToNames(lang) {
            const outputLanguage = lang.toUpperCase();
            return {
                "ç¾å›½|ç¾åœ‹|US|æ´›æ‰çŸ¶|æ´›æ‰ç£¯|è¥¿é›…å›¾|çº½çº¦|èŠåŠ å“¥|Atlanta|States|American|Los Angeles|Seattle|New York|Chicago": outputLanguage === "CN" ? "ğŸ‡ºğŸ‡¸ç¾å›½" : "ğŸ‡ºğŸ‡¸US",
                "æ¸¯|é¦™æ¸¯|HK|Hong Kong": outputLanguage === "CN" ? "ğŸ‡­ğŸ‡°é¦™æ¸¯" : "ğŸ‡­ğŸ‡°HK",
                "æ–°åŠ å¡|ç‹®åŸ|SG|Singapore": outputLanguage === "CN" ? "ğŸ‡¸ğŸ‡¬æ–°åŠ å¡" : "ğŸ‡¸ğŸ‡¬SG",
                "å°|å°æ¹¾|å°åŒ—|é«˜é›„|TW|Taiwan|Taipei|Kaohsiung": outputLanguage === "CN" ? "ğŸ‡¨ğŸ‡³å°æ¹¾" : "ğŸ‡¨ğŸ‡³TW",
                "æ—¥|ä¸œäº¬|å¤§é˜ª|åå¤å±‹|JP|Tokyo|Japan|Osaka|Nagoya": outputLanguage === "CN" ? "ğŸ‡¯ğŸ‡µæ—¥æœ¬" : "ğŸ‡¯ğŸ‡µJP",
                "éŸ©å›½|é¦–å°”|é‡œå±±|KR|Korea|Seoul|Busan": outputLanguage === "CN" ? "ğŸ‡°ğŸ‡·éŸ©å›½" : "ğŸ‡°ğŸ‡·KR",
                // ... æ›´å¤šå›½å®¶æ˜ å°„
            };
        }

        // è¿‡æ»¤å…³é”®è¯
        const filterKeywords = [
            "å¹¿å‘Š", "è¿‡æœŸ", "æ— æ•ˆ", "æµ‹è¯•", "å¤‡ç”¨", "å®˜ç½‘", "è´¦å·", "æœ‰æ•ˆæœŸ", "ç¾¤",
            "åˆ°æœŸ", "åˆ·æ–°", "å‰©ä½™", "ç”µæŠ¥", "ä¼šå‘˜", "è§£é”", "æµé‡", "è¶…æ—¶",
            "Days", "Date", "Expire", "Premium", "å»ºè®®", "å…è´¹", "TEST"
        ];

        // å¤„ç†èŠ‚ç‚¹åç§°çš„æ ¸å¿ƒå‡½æ•° (ä» _worker.js ç§»æ¤)
        function processNodeName(originalName, lang, prefix, suffix) {
            const keywordsToNames = getKeywordsToNames(lang);
            
            // æ£€æŸ¥è¿‡æ»¤å…³é”®è¯
            if (filterKeywords.some(kw => new RegExp(kw, 'i').test(originalName))) {
                return null;
            }

            let newTitle = originalName;
            let matched = false;

            // åœ°åŒºå…³é”®è¯åŒ¹é…
            for (const keyword in keywordsToNames) {
                if (new RegExp(keyword, 'i').test(newTitle)) {
                    newTitle = keywordsToNames[keyword];
                    matched = true;
                    break;
                }
            }

            if (!matched) {
                newTitle = originalName.replace(/[^\w\s\-\u4e00-\u9fa5]/g, '').trim();
            }

            return prefix + newTitle + suffix;
        }

        // æ ¼å¼æ£€æµ‹å‡½æ•°
        function detectFormat(content) {
            try {
                JSON.parse(content);
                return 'json';
            } catch {}

            if (content.includes('proxies:') || content.includes('proxy-groups:')) {
                return 'yaml';
            }

            try {
                atob(content.trim());
                return 'base64';
            } catch {}

            return 'unknown';
        }

        // å¤„ç† Base64 è®¢é˜…
        function processBase64Subscription(content, lang, prefix, suffix) {
            try {
                const decodedContent = atob(content.trim());
                const nodes = decodedContent.split('\n').filter(node => node.trim());
                
                const processedNodes = nodes.map(node => {
                    if (node.includes('#')) {
                        const parts = node.split('#');
                        const originalName = decodeURIComponent(parts[parts.length - 1]);
                        const processedName = processNodeName(originalName, lang, prefix, suffix);
                        
                        if (processedName) {
                            parts[parts.length - 1] = encodeURIComponent(processedName);
                            return parts.join('#');
                        }
                    }
                    return node;
                }).filter(Boolean);
                
                return btoa(processedNodes.join('\n'));
            } catch (error) {
                throw new Error('Base64 å¤„ç†å¤±è´¥: ' + error.message);
            }
        }

        // ä¸»å¤„ç†å‡½æ•°
        async function processSubscription() {
            const url = document.getElementById('subscriptionUrl').value;
            const lang = document.getElementById('language').value;
            const prefix = document.getElementById('prefix').value;
            const suffix = document.getElementById('suffix').value;

            if (!url) {
                showStatus('è¯·è¾“å…¥è®¢é˜…é“¾æ¥', 'error');
                return;
            }

            showStatus('æ­£åœ¨è·å–è®¢é˜…å†…å®¹...', 'info');

            try {
                // ä½¿ç”¨ CORS ä»£ç†è·å–è®¢é˜…å†…å®¹
                const proxyUrl = `https://cors-anywhere.herokuapp.com/${url}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const content = await response.text();
                originalFormat = detectFormat(content);

                showStatus('æ­£åœ¨å¤„ç†èŠ‚ç‚¹åç§°...', 'info');

                // æ ¹æ®æ ¼å¼å¤„ç†
                switch (originalFormat) {
                    case 'base64':
                        processedContent = processBase64Subscription(content, lang, prefix, suffix);
                        break;
                    case 'json':
                        // Sing-box æ ¼å¼å¤„ç†
                        const config = JSON.parse(content);
                        if (config.outbounds) {
                            config.outbounds = config.outbounds.map(outbound => {
                                if (outbound.tag && !['direct', 'block'].includes(outbound.tag)) {
                                    const processed = processNodeName(outbound.tag, lang, prefix, suffix);
                                    if (processed) outbound.tag = processed;
                                }
                                return outbound;
                            });
                        }
                        processedContent = JSON.stringify(config, null, 2);
                        break;
                    case 'yaml':
                        // Clash æ ¼å¼å¤„ç† (ç®€åŒ–ç‰ˆ)
                        const lines = content.split('\n');
                        const processedLines = lines.map(line => {
                            const nameMatch = line.match(/^(\s*-?\s*name:\s*['"]?)(.+?)(['"]?\s*)$/);
                            if (nameMatch) {
                                const processed = processNodeName(nameMatch[2], lang, prefix, suffix);
                                if (processed) {
                                    return nameMatch[1] + processed + nameMatch[3];
                                }
                            }
                            return line;
                        });
                        processedContent = processedLines.join('\n');
                        break;
                    default:
                        throw new Error('ä¸æ”¯æŒçš„è®¢é˜…æ ¼å¼');
                }

                showStatus('å¤„ç†å®Œæˆï¼', 'success');
                showPreview();

            } catch (error) {
                showStatus('å¤„ç†å¤±è´¥: ' + error.message, 'error');
                
                // æç¤ºç”¨æˆ·å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ
                if (error.message.includes('CORS')) {
                    showStatus('CORS é”™è¯¯ï¼šè¯·å°è¯•ä½¿ç”¨ CORS ä»£ç†æˆ–ç›´æ¥å¤åˆ¶è®¢é˜…å†…å®¹', 'error');
                }
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // æ˜¾ç¤ºé¢„è§ˆ
        function showPreview() {
            const previewDiv = document.getElementById('preview');
            const resultDiv = document.getElementById('result');
            
            // ç®€å•é¢„è§ˆå‰å‡ è¡Œ
            const preview = processedContent.substring(0, 500) + (processedContent.length > 500 ? '...' : '');
            
            previewDiv.innerHTML = `
                <div class="preview">
                    <h3>ğŸ“‹ å¤„ç†ç»“æœé¢„è§ˆ</h3>
                    <p><strong>åŸå§‹æ ¼å¼:</strong> ${originalFormat.toUpperCase()}</p>
                    <p><strong>å†…å®¹é•¿åº¦:</strong> ${processedContent.length} å­—ç¬¦</p>
                    <pre>${preview}</pre>
                </div>
            `;
            
            resultDiv.innerHTML = `<textarea readonly style="width:100%; height:300px; font-family: monospace;">${processedContent}</textarea>`;
            resultDiv.style.display = 'block';
        }

        // ä¸‹è½½ç»“æœ
        function downloadResult() {
            if (!processedContent) {
                showStatus('æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹', 'error');
                return;
            }

            const blob = new Blob([processedContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `filtered_subscription_${Date.now()}.${originalFormat === 'json' ? 'json' : 'txt'}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus('æ–‡ä»¶ä¸‹è½½å·²å¼€å§‹', 'success');
        }
    </script>
</body>
</html>
