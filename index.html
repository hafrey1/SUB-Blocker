<!doctype html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>è®¢é˜…èŠ‚ç‚¹åç§°è¿‡æ»¤å™¨ Â· å‰ç«¯å·¥å…·ï¼ˆGitHub Pages + Cloudflare Workersï¼‰</title>
	<style>
		:root{--fg:#111;--muted:#666;--bg:#fff;--card:#f6f6f7;--br:10px;--pri:#2563eb;--pri-h:#1d4ed8;--ok:#0a7f3f;--err:#b00020}
		*{box-sizing:border-box}
		body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; margin:24px; line-height:1.6; color:var(--fg); background:var(--bg)}
		h1{font-size:22px; margin:0 0 12px}
		.small{color:var(--muted); font-size:12px}
		.card{background:var(--card); padding:16px; border-radius:var(--br); margin:12px 0}
		.row{margin:10px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
		.grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
		label{display:block; margin-bottom:6px}
		input, textarea, select, button{font:inherit; padding:8px 10px;}
		input,textarea,select{width:100%; border:1px solid #e3e3e8; border-radius:8px; background:#fff}
		button{background:var(--pri); color:#fff; border:0; border-radius:8px; padding:10px 16px; cursor:pointer}
		button.secondary{background:#6b7280}
		button:disabled{opacity:.7; cursor:not-allowed}
		button:hover{background:var(--pri-h)}
		code, pre{background:#f1f3f5; padding:8px; border-radius:8px}
		.success{color:var(--ok)}
		.error{color:var(--err)}
	</style>
</head>
<body>
	<h1>ğŸ“¡ è®¢é˜…èŠ‚ç‚¹åç§°è¿‡æ»¤å™¨ï¼ˆGitHub Pages + Cloudflare Workersï¼‰</h1>
	<p class="small">é™æ€é¡µé¢æ‰˜ç®¡äº GitHub Pagesï¼Œåç«¯ç”± Cloudflare Workers æä¾›ã€‚å¯é€‰æ‹©ç”Ÿæˆ Base64ã€Clashã€Sing-box è®¢é˜…ã€‚</p>

	<div class="card">
		<div class="row" style="display:block;">
			<label>Workers æ¥å£åœ°å€</label>
			<input id="endpoint" placeholder="https://your-worker.example.com/convert" value="https://sub.527188.xyz">
			<div class="small">ç¡®ä¿å·²æ­£ç¡®é…ç½® CORS å…è®¸æ­¤é¡µé¢æ¥æºã€‚</div>
		</div>

		<div class="row" style="display:block;">
			<label>è®¢é˜…é“¾æ¥ï¼ˆURLï¼‰</label>
			<input id="subUrl" placeholder="https://provider.example.com/sub?token=...">
			<div class="small">è‹¥ Workers æ”¯æŒè‡ªè¡Œæ‹‰å–ï¼Œå¯ä¸å¡«ï¼Œä»…ä¼ å¤„ç†å‚æ•°ã€‚</div>
		</div>

		<div class="grid">
			<div>
				<label>åŒ…å«å…³é”®å­—ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
				<input id="include" placeholder="é¦™æ¸¯,æ—¥æœ¬,ç¾å›½">
			</div>
			<div>
				<label>æ’é™¤å…³é”®å­—ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
				<input id="exclude" placeholder="æ¸¸æˆ,æµ‹é€Ÿ,å‰©ä½™æµé‡">
			</div>
		</div>

		<div class="grid">
			<div>
				<label>å‰ç¼€</label>
				<input id="prefix" placeholder="[My]">
			</div>
			<div>
				<label>åç¼€</label>
				<input id="suffix" placeholder="-AUTO">
			</div>
		</div>

		<div class="grid">
			<div>
				<label>åœ°åŒºæ ‡è¯†ç­–ç•¥</label>
				<select id="region">
					<option value="">ä¸å¤„ç†</option>
					<option value="emoji">å›½æ—— Emoji</option>
					<option value="iso">ISO ä»£ç </option>
					<option value="cn">ä¸­æ–‡ç®€ç§°</option>
				</select>
			</div>
			<div>
				<label>è¾“å‡ºæ ¼å¼</label>
				<select id="outFormat">
					<option value="raw">åŸæ–‡</option>
					<option value="base64">Base64 è®¢é˜…</option>
					<option value="clash">Clash è®¢é˜…</option>
					<option value="singbox">Sing-box è®¢é˜…</option>
				</select>
				<div class="small">Clash ä¸ Sing-box ä¼˜å…ˆç”± Workers ç›´æ¥ç”Ÿæˆï¼›è‹¥æœªå®ç°å°†å›é€€ä¸ºåŸæ–‡æˆ– Base64ã€‚</div>
			</div>
		</div>

		<div class="row">
			<button id="run">ç”Ÿæˆ</button>
			<button id="copy" class="secondary">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
			<button id="download" class="secondary">ä¸‹è½½ä¸ºæ–‡ä»¶</button>
			<span id="status" class="small"></span>
		</div>

		<div class="row" style="display:block;">
			<label>è¾“å‡º</label>
			<textarea id="output" rows="14" placeholder="å¤„ç†ç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œæ”¯æŒç›´æ¥å¤åˆ¶æˆ–ä¸‹è½½"></textarea>
		</div>
	</div>

	<script>
	function normalizeCSV(s){return s.split(',').map(x=>x.trim()).filter(Boolean).join(',')}
	function b64(text){return btoa(unescape(encodeURIComponent(text)))}

	async function callWorker(endpoint, options){
		const q = new URLSearchParams();
		for(const [k,v] of Object.entries(options)){
			if(v!==undefined && v!==null && String(v).trim()!=='') q.set(k, v);
		}
		const sep = endpoint.includes('?') ? '&' : '?';
		const url = endpoint + (q.toString() ? sep + q.toString() : '');
		const res = await fetch(url, {method:'GET', mode:'cors', headers:{'Accept':'text/plain, application/json;q=0.9'}});
		const text = await res.text();
		if(!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
		return {text, ct: res.headers.get('Content-Type')||''};
	}

	document.getElementById('run').addEventListener('click', async ()=>{
		const btn=document.getElementById('run');
		const status=document.getElementById('status');
		const output=document.getElementById('output');
		const endpoint=document.getElementById('endpoint').value.trim();
		const subUrl=document.getElementById('subUrl').value.trim();
		const include=normalizeCSV(document.getElementById('include').value);
		const exclude=normalizeCSV(document.getElementById('exclude').value);
		const prefix=document.getElementById('prefix').value.trim();
		const suffix=document.getElementById('suffix').value.trim();
		const region=document.getElementById('region').value;
		const outFormat=document.getElementById('outFormat').value;

		btn.disabled=true; status.textContent='è¯·æ±‚ä¸­...'; status.className='small';
		try{
			const wanted = (outFormat==='clash'||outFormat==='singbox') ? outFormat : 'raw';
			const {text} = await callWorker(endpoint, { url: subUrl, include, exclude, prefix, suffix, region, format: wanted });
			let finalText = text;
			if(outFormat==='base64') finalText = b64(text);

			// ç®€å•çš„å›é€€æç¤ºï¼ˆæ§åˆ¶å°ï¼‰
			if(outFormat==='clash'){
				const looksClash = text.trimStart().startsWith('proxies:') || text.includes('proxy-groups:');
				if(!looksClash) console.warn('Workers å¯èƒ½å°šæœªå®ç° clash è¾“å‡ºï¼Œå·²å›é€€ä¸ºåŸæ–‡');
			}
			if(outFormat==='singbox'){
				const t=text.trimStart(); const looksJson = t.startsWith('{')||t.startsWith('[');
				if(!looksJson) console.warn('Workers å¯èƒ½å°šæœªå®ç° singbox è¾“å‡ºï¼Œå·²å›é€€ä¸ºåŸæ–‡');
			}

			output.value = finalText;
			status.textContent='æˆåŠŸ'; status.className='small success';
		}catch(e){
			console.error(e); output.value=''; status.textContent='å¤±è´¥ï¼š'+e.message; status.className='small error';
		}finally{ btn.disabled=false; }
	});

	document.getElementById('copy').addEventListener('click', async()=>{
		const v=document.getElementById('output').value; if(!v) return;
		await navigator.clipboard.writeText(v);
		const s=document.getElementById('status'); s.textContent='å·²å¤åˆ¶'; s.className='small success';
	});

	document.getElementById('download').addEventListener('click', ()=>{
		const v=document.getElementById('output').value; if(!v) return;
		const fmt=document.getElementById('outFormat').value;
		const map={raw:'txt', base64:'txt', clash:'yaml', singbox:'json'};
		const ext = map[fmt]||'txt';
		const blob=new Blob([v], {type:'text/plain;charset=utf-8'});
		const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`subscription.${ext}`; a.click();
		URL.revokeObjectURL(a.href);
	});
	</script>
</body>
</html>
